"""
Handler –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞ —á–µ—Ä–µ–∑ XTTS-v2.
–ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –æ–±—Ä–∞–∑—Ü—ã –≥–æ–ª–æ—Å–æ–≤, –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –∏ —Å–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—á—å.
"""
import os
import tempfile
from pathlib import Path

from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, FSInputFile
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State

from utils.keyboards import (
    BTN_BACK, BTN_VOICE_CLONE,
    voice_clone_main_kb, cloned_voices_list_kb,
    cloned_voices_inline_kb, main_kb
)
from db.database import (
    cloned_voices_list, cloned_voice_add, cloned_voice_get,
    cloned_voice_delete, cloned_voice_get_by_id, cloned_voice_delete_by_id
)
from utils.xtts import (
    clone_voice_from_sample, synthesize_with_cloned_voice,
    get_voice_sample_path, delete_voice_files, delete_voice_elevenlabs
)

router = Router()


class VoiceCloneFSM(StatesGroup):
    """FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞"""
    main_menu = State()           # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    add_waiting_file = State()    # –û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –≥–æ–ª–æ—Å–æ–º
    add_waiting_name = State()    # –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞
    add_waiting_lang = State()    # –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
    synthesize_select_voice = State()  # –í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞
    synthesize_waiting_text = State()  # –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞
    list_voices = State()         # –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤


# ===== –í–•–û–î –í –ú–ï–ù–Æ –ö–õ–û–ù–ò–†–û–í–ê–ù–ò–Ø =====

@router.message(F.text == BTN_VOICE_CLONE)
async def voice_clone_menu(message: Message, state: FSMContext):
    """–í—Ö–æ–¥ –≤ –º–µ–Ω—é –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞"""
    await state.set_state(VoiceCloneFSM.main_menu)
    await message.answer(
        "üé§ <b>–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞</b>\n\n"
        "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:\n"
        "‚Ä¢ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –≥–æ–ª–æ—Å –∏–∑ –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ —Ñ–∞–π–ª–∞\n"
        "‚Ä¢ –û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≥–æ–ª–æ—Å–æ–º\n"
        "‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –≥–æ–ª–æ—Å–∞–º–∏",
        reply_markup=voice_clone_main_kb()
    )


# ===== –ù–ê–ó–ê–î =====

@router.message(VoiceCloneFSM.main_menu, F.text == BTN_BACK)
async def back_to_main(message: Message, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await state.clear()
    await message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", reply_markup=main_kb())


@router.message(VoiceCloneFSM.add_waiting_file, F.text == BTN_BACK)
@router.message(VoiceCloneFSM.add_waiting_name, F.text == BTN_BACK)
@router.message(VoiceCloneFSM.add_waiting_lang, F.text == BTN_BACK)
@router.message(VoiceCloneFSM.synthesize_select_voice, F.text == BTN_BACK)
@router.message(VoiceCloneFSM.synthesize_waiting_text, F.text == BTN_BACK)
@router.message(VoiceCloneFSM.list_voices, F.text == BTN_BACK)
async def back_to_clone_menu(message: Message, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"""
    await state.set_state(VoiceCloneFSM.main_menu)
    await state.update_data(temp_file=None, voice_name=None, voice_lang=None)
    await message.answer(
        "üé§ <b>–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞</b>",
        reply_markup=voice_clone_main_kb()
    )


# ===== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ì–û–õ–û–°–ê =====

@router.message(VoiceCloneFSM.main_menu, F.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å")
async def add_voice_start(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–∞"""
    await state.set_state(VoiceCloneFSM.add_waiting_file)
    await message.answer(
        "üìÅ <b>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑—Ü–∞ –≥–æ–ª–æ—Å–∞</b>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ —Ñ–∞–π–ª —Å –æ–±—Ä–∞–∑—Ü–æ–º –≥–æ–ª–æ—Å–∞.\n\n"
        "<b>üéØ –î–ª—è –õ–£–ß–®–ï–ì–û –∫–∞—á–µ—Å—Ç–≤–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</b>\n"
        "‚Ä¢ ‚è± <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 15-60 —Å–µ–∫—É–Ω–¥</b> (—á–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º –ª—É—á—à–µ)\n"
        "‚Ä¢ üéô <b>–ß–∏—Å—Ç–∞—è —Ä–µ—á—å</b> –±–µ–∑ –º—É–∑—ã–∫–∏, —à—É–º–∞, —ç—Ö–∞\n"
        "‚Ä¢ üó£ <b>–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è</b> (–∫–∞–∫ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ)\n"
        "‚Ä¢ üì¢ <b>–ì—Ä–æ–º–∫–∞—è –∏ —á–µ—Ç–∫–∞—è</b> –¥–∏–∫—Ü–∏—è\n"
        "‚Ä¢ üö´ <b>–ë–µ–∑ –ø–∞—É–∑</b> –¥–ª–∏–Ω–Ω–µ–µ 1-2 —Å–µ–∫—É–Ω–¥\n"
        "‚Ä¢ üé≠ <b>–†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ</b> - —Ä–∞–∑–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —ç–º–æ—Ü–∏–∏\n\n"
        "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:\n"
        "‚Ä¢ –í–∏–¥–µ–æ: MP4, AVI, MKV, MOV, WebM\n"
        "‚Ä¢ –ê—É–¥–∏–æ: MP3, WAV, OGG, FLAC, M4A\n\n"
        "‚ö†Ô∏è <i>–ö–∞—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–∑—Ü–∞ = –∫–∞—á–µ—Å—Ç–≤–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è!</i>"
    )


@router.message(VoiceCloneFSM.add_waiting_file, F.video | F.audio | F.voice | F.document)
async def add_voice_receive_file(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –≥–æ–ª–æ—Å–æ–º"""
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
    if message.video:
        file = message.video
        ext = ".mp4"
    elif message.audio:
        file = message.audio
        ext = ".mp3"
    elif message.voice:
        file = message.voice
        ext = ".ogg"
    elif message.document:
        file = message.document
        # –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        if file.file_name:
            ext = Path(file.file_name).suffix.lower()
        else:
            ext = ".mp4"
    else:
        await message.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Ñ–∞–π–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
    allowed_ext = [".mp4", ".avi", ".mkv", ".mov", ".webm", ".mp3", ".wav", ".ogg", ".flac", ".m4a"]
    if ext not in allowed_ext:
        await message.answer(
            f"‚ùå –§–æ—Ä–º–∞—Ç {ext} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.\n"
            f"–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: {', '.join(allowed_ext)}"
        )
        return

    # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    await message.answer("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–∞–π–ª...")

    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    temp_dir = Path(tempfile.gettempdir()) / "voice_clone"
    temp_dir.mkdir(exist_ok=True)

    temp_path = temp_dir / f"sample_{message.from_user.id}{ext}"

    try:
        await message.bot.download(file, destination=temp_path)
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {e}")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –≤ FSM
    await state.update_data(temp_file=str(temp_path))
    await state.set_state(VoiceCloneFSM.add_waiting_name)

    await message.answer(
        "‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!\n\n"
        "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ–ª–æ—Å–∞.\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: <i>–ê–ª–µ–∫—Å–∞–Ω–¥—Ä</i>, <i>Narrator_EN</i>, <i>My_Voice</i>\n\n"
        "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è"
    )


@router.message(VoiceCloneFSM.add_waiting_name, F.text)
async def add_voice_set_name(message: Message, state: FSMContext):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–∞"""
    name = message.text.strip()

    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏
    if not name:
        await message.answer("‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        return

    if len(name) > 50:
        await message.answer("‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤)")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    import re
    if not re.match(r'^[\w\-]+$', name):
        await message.answer(
            "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –∏ –¥–µ—Ñ–∏—Å—ã."
        )
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
    existing = await cloned_voice_get(name)
    if existing:
        await message.answer(
            f"‚ùå –ì–æ–ª–æ—Å —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º <b>{name}</b> —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ."
        )
        return

    await state.update_data(voice_name=name)
    await state.set_state(VoiceCloneFSM.add_waiting_lang)

    await message.answer(
        f"‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{name}</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ –≥–æ–ª–æ—Å–∞:\n\n"
        "üá∑üá∫ <code>ru</code> - –†—É—Å—Å–∫–∏–π\n"
        "üá¨üáß <code>en</code> - English\n"
        "üá™üá∏ <code>es</code> - Espa√±ol\n"
        "üá©üá™ <code>de</code> - Deutsch\n"
        "üá´üá∑ <code>fr</code> - Fran√ßais\n"
        "üáÆüáπ <code>it</code> - Italiano\n"
        "üáµüá± <code>pl</code> - Polski\n"
        "üá®üá≥ <code>zh-cn</code> - ‰∏≠Êñá\n"
        "üáØüáµ <code>ja</code> - Êó•Êú¨Ë™û\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —è–∑—ã–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: <code>ru</code> –∏–ª–∏ <code>en</code>)"
    )


@router.message(VoiceCloneFSM.add_waiting_lang, F.text)
async def add_voice_set_lang(message: Message, state: FSMContext):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —è–∑—ã–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞"""
    lang = message.text.strip().lower()

    # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏ ElevenLabs
    supported_langs = [
        "en", "ru", "es", "fr", "de", "it", "pt", "pl", "tr",
        "nl", "cs", "ar", "zh", "ja", "ko", "hi", "id"
    ]

    if lang not in supported_langs:
        await message.answer(
            f"‚ùå –Ø–∑—ã–∫ <code>{lang}</code> –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —è–∑—ã–∫–∏: {', '.join(supported_langs)}"
        )
        return

    data = await state.get_data()
    temp_file = data.get("temp_file")
    voice_name = data.get("voice_name")

    if not temp_file or not voice_name:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        await state.set_state(VoiceCloneFSM.main_menu)
        return

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—Ä–∞–∑–µ—Ü –≥–æ–ª–æ—Å–∞
    await message.answer("‚è≥ –ó–∞–≥—Ä—É–∂–∞—é –≥–æ–ª–æ—Å –≤ ElevenLabs... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–∏–Ω—É—Ç—É.")

    try:
        # –ö–ª–æ–Ω–∏—Ä—É–µ–º –≥–æ–ª–æ—Å —á–µ—Ä–µ–∑ ElevenLabs API
        voice_id = await clone_voice_from_sample(
            sample_path=temp_file,
            voice_name=voice_name,
            language=lang
        )

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î (voice_id –≤–º–µ—Å—Ç–æ sample_path)
        await cloned_voice_add(
            name=voice_name,
            sample_path=voice_id,  # –¢–µ–ø–µ—Ä—å —ç—Ç–æ voice_id –∏–∑ ElevenLabs
            language=lang,
            created_by=message.from_user.id
        )

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if os.path.exists(temp_file):
            os.remove(temp_file)

        await message.answer(
            f"‚úÖ <b>–ì–æ–ª–æ—Å —É—Å–ø–µ—à–Ω–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω!</b>\n\n"
            f"üìõ –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{voice_name}</b>\n"
            f"üåç –Ø–∑—ã–∫: <b>{lang}</b>\n"
            f"üîë Voice ID: <code>{voice_id[:20]}...</code>\n\n"
            f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –≥–æ–ª–æ—Å –¥–ª—è –æ–∑–≤—É—á–∫–∏ —Ç–µ–∫—Å—Ç–∞.\n"
            f"‚ö†Ô∏è –ö–∞—á–µ—Å—Ç–≤–æ ElevenLabs –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ XTTS!",
            reply_markup=voice_clone_main_kb()
        )

        await state.set_state(VoiceCloneFSM.main_menu)
        await state.update_data(temp_file=None, voice_name=None, voice_lang=None)

    except Exception as e:
        await message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏:\n<code>{str(e)}</code>\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
            "‚Ä¢ ELEVENLABS_API_KEY –≤ .env\n"
            "‚Ä¢ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç–µ\n"
            "‚Ä¢ –§–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω"
        )
        await state.set_state(VoiceCloneFSM.main_menu)


# ===== –û–ó–í–£–ß–ö–ê –¢–ï–ö–°–¢–ê =====

@router.message(VoiceCloneFSM.main_menu, F.text == "üéô –û–∑–≤—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç")
async def synthesize_start(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –æ–∑–≤—É—á–∫–∏ —Ç–µ–∫—Å—Ç–∞"""
    voices = await cloned_voices_list()

    if not voices:
        await message.answer(
            "‚ùå –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤.\n"
            "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ '‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å'"
        )
        return

    voice_names = [v["name"] for v in voices]
    await state.set_state(VoiceCloneFSM.synthesize_select_voice)

    await message.answer(
        "üéô <b>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–ª–æ—Å –¥–ª—è –æ–∑–≤—É—á–∫–∏:</b>",
        reply_markup=cloned_voices_list_kb(voice_names)
    )


@router.message(VoiceCloneFSM.synthesize_select_voice, F.text)
async def synthesize_select(message: Message, state: FSMContext):
    """–í—ã–±–æ—Ä –≥–æ–ª–æ—Å–∞ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞"""
    if message.text == BTN_BACK:
        return  # –û–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –≤ back_to_clone_menu

    voice_name = message.text.strip()
    voice = await cloned_voice_get(voice_name)

    if not voice:
        await message.answer(f"‚ùå –ì–æ–ª–æ—Å '{voice_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞.")
        return

    await state.update_data(
        selected_voice=voice_name,
        voice_lang=voice.get("language", "ru")
    )
    await state.set_state(VoiceCloneFSM.synthesize_waiting_text)

    await message.answer(
        f"‚úÖ –í—ã–±—Ä–∞–Ω –≥–æ–ª–æ—Å: <b>{voice_name}</b>\n"
        f"üåç –Ø–∑—ã–∫: <b>{voice.get('language', 'ru')}</b>\n\n"
        "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ–∑–≤—É—á–∏—Ç—å.\n\n"
        "‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º: 1000 —Å–∏–º–≤–æ–ª–æ–≤\n"
        "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ —è–∑—ã–∫–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞"
    )


@router.message(VoiceCloneFSM.synthesize_waiting_text, F.text)
async def synthesize_text(message: Message, state: FSMContext):
    """–°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ —Å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≥–æ–ª–æ—Å–æ–º"""
    if message.text == BTN_BACK:
        return

    text = message.text.strip()

    if not text:
        await message.answer("‚ùå –¢–µ–∫—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        return

    if len(text) > 5000:
        await message.answer(
            f"‚ùå –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π ({len(text)} —Å–∏–º–≤–æ–ª–æ–≤).\n"
            "–ú–∞–∫—Å–∏–º—É–º: 5000 —Å–∏–º–≤–æ–ª–æ–≤"
        )
        return

    data = await state.get_data()
    voice_name = data.get("selected_voice")

    voice = await cloned_voice_get(voice_name)
    if not voice:
        await message.answer("‚ùå –ì–æ–ª–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        await state.set_state(VoiceCloneFSM.main_menu)
        return

    voice_id = voice.get("sample_path")  # –¢–µ–ø–µ—Ä—å —ç—Ç–æ voice_id
    if not voice_id:
        await message.answer("‚ùå Voice ID –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≥–æ–ª–æ—Å.")
        await state.set_state(VoiceCloneFSM.main_menu)
        return

    # –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ–º —Ä–µ—á—å
    await message.answer("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ–∑–≤—É—á–∫—É —á–µ—Ä–µ–∑ ElevenLabs...")

    try:
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        output_path = tempfile.mktemp(suffix=".mp3")

        # –°–∏–Ω—Ç–µ–∑–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ ElevenLabs
        result_path = await synthesize_with_cloned_voice(
            text=text,
            voice_id=voice_id,
            output_path=output_path,
            stability=0.5,
            similarity_boost=0.75
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ
        audio_file = FSInputFile(result_path)
        await message.answer_audio(
            audio_file,
            caption=f"üéô –ì–æ–ª–æ—Å: <b>{voice_name}</b>\nüìù –¢–µ–∫—Å—Ç: <i>{text[:100]}{'...' if len(text) > 100 else ''}</i>"
        )

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if os.path.exists(result_path):
            os.remove(result_path)

        await message.answer(
            "‚úÖ –û–∑–≤—É—á–∫–∞ –≥–æ—Ç–æ–≤–∞!\n\n"
            "–ú–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥.",
            reply_markup=voice_clone_main_kb()
        )

        await state.set_state(VoiceCloneFSM.main_menu)

    except Exception as e:
        await message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞:\n<code>{str(e)}</code>\n\n"
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∫—Ä–µ–¥–∏—Ç–æ–≤ ElevenLabs."
        )


# ===== –°–ü–ò–°–û–ö –ì–û–õ–û–°–û–í =====

@router.message(VoiceCloneFSM.main_menu, F.text == "üìã –°–ø–∏—Å–æ–∫ –≥–æ–ª–æ—Å–æ–≤")
async def list_voices(message: Message, state: FSMContext):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≥–æ–ª–æ—Å–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∏—è"""
    voices = await cloned_voices_list()

    if not voices:
        await message.answer(
            "üìã <b>–°–ø–∏—Å–æ–∫ –≥–æ–ª–æ—Å–æ–≤ –ø—É—Å—Ç</b>\n\n"
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤.\n"
            "–î–æ–±–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ '‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å'"
        )
        return

    text = "üìã <b>–í–∞—à–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥–æ–ª–æ—Å–∞:</b>\n\n"
    for i, v in enumerate(voices, 1):
        name = v.get("name", "Unknown")
        lang = v.get("language", "?")
        created = v.get("created_at", "")
        if created:
            created_str = created.strftime("%d.%m.%Y")
        else:
            created_str = "N/A"
        text += f"{i}. <b>{name}</b> ({lang}) - {created_str}\n"

    text += "\nüóë –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–æ–ª–æ—Å –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –µ–≥–æ:"

    await message.answer(text, reply_markup=cloned_voices_inline_kb(voices))


# ===== CALLBACK: –£–î–ê–õ–ï–ù–ò–ï –ì–û–õ–û–°–ê =====

@router.callback_query(F.data.startswith("vclone:del:"))
async def delete_voice_callback(callback: CallbackQuery):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞"""
    db_voice_id = callback.data.split(":")[2]

    voice = await cloned_voice_get_by_id(db_voice_id)
    if not voice:
        await callback.answer("‚ùå –ì–æ–ª–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    voice_name = voice.get("name", "Unknown")
    elevenlabs_voice_id = voice.get("sample_path", "")  # –≠—Ç–æ voice_id –∏–∑ ElevenLabs

    # –£–¥–∞–ª—è–µ–º –∏–∑ ElevenLabs
    if elevenlabs_voice_id:
        try:
            await delete_voice_elevenlabs(elevenlabs_voice_id)
        except Exception:
            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ API

    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å –¥–∏—Å–∫–∞
    delete_voice_files(voice_name)

    # –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î
    await cloned_voice_delete_by_id(db_voice_id)

    await callback.answer(f"‚úÖ –ì–æ–ª–æ—Å '{voice_name}' —É–¥–∞–ª–µ–Ω", show_alert=True)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    voices = await cloned_voices_list()
    if voices:
        text = "üìã <b>–í–∞—à–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥–æ–ª–æ—Å–∞:</b>\n\n"
        for i, v in enumerate(voices, 1):
            name = v.get("name", "Unknown")
            lang = v.get("language", "?")
            text += f"{i}. <b>{name}</b> ({lang})\n"
        text += "\nüóë –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥–æ–ª–æ—Å, —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å:"
        await callback.message.edit_text(text, reply_markup=cloned_voices_inline_kb(voices))
    else:
        await callback.message.edit_text("üìã <b>–°–ø–∏—Å–æ–∫ –≥–æ–ª–æ—Å–æ–≤ –ø—É—Å—Ç</b>")
